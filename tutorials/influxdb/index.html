<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />

    <script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <style>
    html,
    body {
        height: 100%;
        width: 100%;
    }
    body {
        margin: 0;
    }
    #map {
        width: 100%;
        height: 100%;
    }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
      // initialize Leaflet
var data = null

      // add the OpenStreetMap tiles
var map = L.map('map')
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
      }).addTo(map)
      map.fitBounds([
        [67, 147],
        [-63, -189]
      ])
var polyLines = {}
var colors = {}

const updatePath = function(name, latlongs, colors) {
  let lat = _.filter(latlongs, {_field: 'lat'})[0]._value
  let lon = _.filter(latlongs, {_field: 'long'})[0]._value
  if (name in polyLines) {
    polyLines[name].addLatLng([lat, lon])
  } else {
    polyLines[name] = L.polyline([[lat, lon]], {color: colors[name]})
    polyLines[name].addTo(map)
  }
}

$(document).ready(function() {
  $.getJSON('floats.json').done(
    function(resp) {
      data = resp
      var keys = _.keys(resp[0]);
      let n_chunks = Math.max(..._.map(resp, 'batch'))
      let chunk_ix = 0
      let expNames = _.map(_.uniqBy(resp, 'exp'), 'exp')
      var colors = _.zipObject(expNames, ["red", "green", "blue", "yellow", "black", "magenta"])
      let pusher = setInterval(function() {
        if (chunk_ix > n_chunks) {
          clearInterval(pusher)
        } else {
          let chunk = _.filter(resp, {batch: chunk_ix})
          chunk = _.zipObject(keys, _.map(keys, key => _.map(chunk, key)));
          $.ajax({
            type: 'POST',
            url: '/data?measurement=latlong&tags=exp',
            data: JSON.stringify(chunk),
            contentType: 'application/json',
            traditional: true,
            success: function(xhr) {
              chunk_ix += 1
            },
            error: console.log
          })
        }
      }, 1000)
      let puller = setInterval(function() {
        $.getJSON('/data?bucket=sofar&_offset=-1s').done(function(d) {
          if (d.length == 0) {
            clearInterval(puller)
          } else {
            let latest = _.groupBy(_.filter(d, i => ['lat', 'long'].includes(i._field)), 'exp')
            for (const [expname, latlongs] of Object.entries(latest)) {
                updatePath(expname, latlongs, colors)
            }
          }
        })
      }, 1000)
    })
})

    </script>
</body>
</html>
