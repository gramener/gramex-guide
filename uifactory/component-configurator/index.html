<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Component Configurator</title>
  <style>
    bs5-tree {
      width: 15rem;
      background: #efefef;
    }

    .container {
      width: 100%;
      height: 50%;
      border-bottom: 1px solid #ddd;
      margin-bottom: 0.5rem;
    }

    .container > iframe {
      width: 100%;
      height: 100%;
    }

    .properties {
      height: 50%;
      overflow-y: auto;
    }

    resizable-pane > section:first-of-type {
      padding: 0.5rem;
    }

    resizable-pane > section:first-of-type > div {
      height: calc(100vh - 1rem);
    }

    bs5-tree li {
      cursor: pointer;
    }

    .active {
      font-weight: bold;
      color: #0d6efd;
    }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
</head>
<body class="d-flex">
  <!-- <nav></nav> -->
  <bs5-tree></bs5-tree>
  <resizable-pane class="w-100 vh-100" direction="horizontal">
    <section style="--size:101%" class="position-relative">
      <button class="toggle-source d-flex rounded-0 rounded-start align-items-center btn btn-secondary position-absolute top-0 end-0 mt-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-code-slash pe-none" viewBox="0 0 16 16">
          <path d="M10.478 1.647a.5.5 0 1 0-.956-.294l-4 13a.5.5 0 0 0 .956.294l4-13zM4.854 4.146a.5.5 0 0 1 0 .708L1.707 8l3.147 3.146a.5.5 0 0 1-.708.708l-3.5-3.5a.5.5 0 0 1 0-.708l3.5-3.5a.5.5 0 0 1 .708 0zm6.292 0a.5.5 0 0 0 0 .708L14.293 8l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l-3.5-3.5a.5.5 0 0 0-.708 0z"/>
        </svg>
      </button>
      <div class="d-flex flex-column">
        <div class="container"></div>
        <div class="properties">
          <ul class="nav nav-pills position-sticky top-0 bg-white" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="pills-properties-tab" data-bs-toggle="pill" data-bs-target="#pills-properties" type="button" role="tab" aria-controls="pills-properties" aria-selected="true">Properties</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="pills-code-tab" data-bs-toggle="pill" data-bs-target="#pills-code" type="button" role="tab" aria-controls="pills-code" aria-selected="false">Code</button>
            </li>
          </ul>
          <div class="tab-content mt-2" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-properties" role="tabpanel" aria-labelledby="pills-properties-tab">
              <component-properties></component-properties>
            </div>
            <div class="tab-pane fade" id="pills-code" role="tabpanel" aria-labelledby="pills-code-tab">
              <code-preview>
              </code-preview>
            </div>
          </div>
        </div>
      </div>
    </section>
    <section style="--size:-1%">
      <monaco-editor language="html"></monaco-editor>
    </section>
  </resizable-pane>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/lodash@4.17.21/lodash.js"></script>
  <!-- https://unpkg.com/uifactory@0.0.6 -->
  <script src="./uifactory.js" import="./components/bs5-components.html ./components/toggle-switch.html ./components/component-properties.html ./components/code-preview.html ./components/resizable-pane.html ./components/monaco-editor.html"></script>
  <script>
    const collections = {}
    async function render() {
      const collectionPaths = [
        './components/bs4-components.html',
        './components/bs5-components.html'
      ]
      for(const collectionPath of collectionPaths) {
        const name = collectionPath.split('/').pop().split('.').shift()
        const text = await fetch(collectionPath).then(res => res.text())
        const collection = document.createElement('template')
        collection.innerHTML = text
        collection.setAttribute('name', name)
        document.body.appendChild(collection)
        collections[name] = Array.from(collection.content.querySelectorAll('template[component]')).map(tmpl => tmpl.getAttribute('component'))
      }
      document.querySelector('bs5-tree').setAttribute('tree', JSON.stringify(collections))
    }
    render()
    const camelize = s => s.replace(/-./g, x => x.toUpperCase()[1])
    const kebabize = str => {
      return str.split('').map((letter, idx) => {
        return letter.toUpperCase() === letter
          ? `${idx !== 0 ? '-' : ''}${letter.toLowerCase()}`
          : letter;
      }).join('');
    }

    function updateCodePreview(prop, value) {
      const iframe = document.querySelector('iframe')
      const componentName = iframe.dataset.component
      const component = iframe.contentWindow.document.querySelector(componentName)
      const properties = Object.assign({}, component.data)
      delete properties.$target
      const originalNode = component.__originalNode.cloneNode(true)
      if(prop !== undefined) {
        component.setAttribute(prop, value)
        properties[camelize(prop)] = value
      }
      Object.keys(properties).forEach(key => {
        // originalNode.setAttribute(kebabize(key), properties[key])
        const kebabKey = kebabize(key)
        const p = component.ui.config.properties.find(p => p.name === kebabKey)
        if('value' in p && properties[key] != p.value) {
          originalNode.setAttribute(kebabKey, properties[key])
        }
      })
      document.querySelector('code-preview').code = originalNode.outerHTML
    }
    document.body.addEventListener('section-resized', function(e) {
      if(!e.target.matches('resizable-pane > div')) return
      document.querySelector('monaco-editor').editor.layout()
    })
    document.body.addEventListener('click', async function(e) {
      if(!e.target.matches('body > bs5-tree li')) return
      e.preventDefault()
      const active = document.querySelector('body > bs5-tree .active')
      if(active) {
        active.classList.remove('active')
      }
      e.target.classList.add('active')

      const collectionName = e.target.closest('details').querySelector('summary').textContent.trim()
      const collection = document.body.querySelector(`template[name=${collectionName}]`).content
      const dependencies = collection.querySelector('template[dependencies]')
      const componentSource = collection.querySelector(`template[component="${e.target.textContent.trim()}"]`)
      const container = document.body.querySelector('.container')
      container.innerHTML = ''
      const iframe = document.createElement('iframe')
      iframe.dataset.component = e.target.textContent
      container.appendChild(iframe)
      const doc = iframe.contentWindow.document
      const usage = document.createElement(e.target.textContent)
      let script = '<script src="https://unpkg.com/lodash@4.17.21/lodash.js"><\/script><script src="./uifactory.js"><\/script>'
      if(dependencies) {
        script += dependencies.innerHTML
      }
      doc.open()
      doc.write(componentSource.outerHTML + script + usage.outerHTML)
      doc.close()
      document.querySelector('monaco-editor').editor.getModel().setValue(componentSource.outerHTML)
      iframe.onload = function(e) {
        document.querySelector('component-properties').properties = doc.body.firstElementChild.ui.config.properties;
        updateCodePreview()
      }
    })
    document.body.addEventListener('click', function(e) {
      if(!e.target.matches('button.toggle-source')) return
      const sections = document.body.querySelectorAll('resizable-pane > section')
      if(sections[1].style.getPropertyValue('--size').startsWith('-')) {
        sections[0].style.setProperty('--size', '50%')
        sections[1].style.setProperty('--size', '50%')
      } else {
        sections[0].style.setProperty('--size', '101%')
        sections[1].style.setProperty('--size', '-1%')
      }
      document.querySelector('monaco-editor').editor.layout()
    })
    document.body.addEventListener('change', function(e) {
      if(!(e.target.matches('component-properties input') || e.target.matches('component-properties toggle-switch'))) return
      updateCodePreview(e.target.getAttribute('name'), e.target.value)
    })
  </script>
</body>
</html>
